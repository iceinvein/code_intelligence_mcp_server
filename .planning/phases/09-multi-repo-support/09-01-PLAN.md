---
phase: 09-multi-repo-support
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/indexer/package/mod.rs
  - src/indexer/package/detector.rs

autonomous: true

must_haves:
  truths:
    - "Package detection module exists with core types"
    - "Manifest files are discovered during workspace scanning"
    - "Vendor directories are filtered out during discovery"
  artifacts:
    - path: "src/indexer/package/mod.rs"
      provides: "Package detection orchestrator with types"
      exports: ["PackageInfo", "RepositoryInfo", "PackageType"]
      min_lines: 50
    - path: "src/indexer/package/detector.rs"
      provides: "Manifest file discovery walking directory tree"
      min_lines: 80
  key_links:
    - from: "src/indexer/package/mod.rs"
      to: "src/indexer/package/detector.rs"
      via: "discover_manifests call in discover_packages"
      pattern: "discover_manifests"
---

<objective>
Create package detection module structure and manifest file detector

**Purpose:** Establish the foundational module structure for package detection with core types (PackageInfo, RepositoryInfo, PackageType) and implement manifest file discovery that walks the workspace directory tree while filtering out vendor directories.

**Output:**
- Package detection module under src/indexer/package/
- Core data types for packages and repositories
- Manifest file discovery that finds package.json, Cargo.toml, go.mod, pyproject.toml, pom.xml, requirements.txt
- Vendor directory filtering (node_modules, target, .git, dist, build, vendor)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md

@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/09-multi-repo-support/09-CONTEXT.md
@.planning/phases/09-multi-repo-support/09-RESEARCH.md

@src/indexer/pipeline/scan.rs
@src/config.rs
</context>

<context>
## Existing Scan Patterns

From src/indexer/pipeline/scan.rs, the file scanning logic provides patterns to follow:
- should_skip_dir() function for filtering directories
- Recursive walk with ignore patterns
- Extension-based filtering

## Module Structure

Following existing patterns in src/indexer/:
- extract/ module has mod.rs with sub-modules
- Each sub-module handles a specific concern

Package detection will follow same pattern:
- mod.rs: orchestrator and types
- detector.rs: manifest discovery
- parsers/: language-specific parsers (in 09-01B)
- git.rs: repository detection (in 09-01C)

## Key Decisions from CONTEXT.md

Package identity: Use filesystem path as primary identifier
Package ID format: SHA-256 hash of manifest_path
Repository ID format: SHA-256 hash of root_path

## Discovery Level: Level 0 (Skip)

All work follows established patterns:
- Directory walking patterns from src/indexer/pipeline/scan.rs
- Module structure patterns from src/indexer/extract/
- No new external dependencies required
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create package detection module structure with core types</name>
  <files>src/indexer/package/mod.rs</files>
  <action>
Create src/indexer/package/mod.rs with:
- PackageInfo struct: { id, name, version, manifest_path, package_type, repository_id }
- RepositoryInfo struct: { id, name, root_path, vcs_type, remote_url }
- PackageType enum: Npm, Cargo, Go, Python, Maven, Unknown
- discover_packages() function signature (stub implementation, will be completed in 01D after parsers and git exist)
- detect_repositories() function signature (stub implementation)
- Re-exports for future sub-modules: pub mod detector; pub mod parsers; pub mod git;

Package ID format: SHA-256 hash of manifest_path (using sha2::Sha256)
Repository ID format: SHA-256 hash of root_path

Add sha2 dependency to Cargo.toml if not already present
  </action>
  <verify>cargo build --lib succeeds with new module</verify>
  <done>Module structure exists with all types and public function signatures</done>
</task>

<task type="auto">
  <name>Task 2: Create manifest file detector</name>
  <files>src/indexer/package/detector.rs</files>
  <action>
Create src/indexer/package/detector.rs with:
- discover_manifests(config: &Config, root: &Path) -> Result<Vec<PathBuf>>
- Walk directory tree similar to scan_files in src/indexer/pipeline/scan.rs
- Look for: package.json, Cargo.toml, go.mod, pom.xml, pyproject.toml, requirements.txt
- Skip vendor directories: node_modules, target, .git, dist, build, vendor
- Return sorted list of unique manifest paths
- Use should_skip_dir logic from scan.rs as reference pattern

Include test function: test_discover_manifests_filters_vendor_dirs()
  </action>
  <verify>cargo test discover_manifests passes</verify>
  <done>All non-vendor manifest files are discoverable in workspace</done>
</task>

</tasks>

<verification>
1. Create test workspace with package.json and Cargo.toml in nested directories
2. Run cargo test discover_manifests
3. Verify vendor directories (node_modules, target) are filtered out
4. Verify all manifest files are found regardless of nesting depth
</verification>

<success_criteria>
- Module compiles with all types defined
- discover_manifests finds all expected manifest files
- Vendor directories are correctly filtered
- Tests pass for manifest discovery
</success_criteria>

<output>
After completion, create `.planning/phases/09-multi-repo-support/09-01-SUMMARY.md`
</output>
