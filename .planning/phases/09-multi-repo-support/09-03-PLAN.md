---
phase: 09-multi-repo-support
plan: 03
type: execute
wave: 1
depends_on: [09-01]
files_modified:
  - src/indexer/package/git.rs
  - src/storage/sqlite/queries/packages.rs
  - src/storage/sqlite/queries/mod.rs
  - src/storage/sqlite/mod.rs

autonomous: true

must_haves:
  truths:
    - "Git repositories are discovered and deduplicated by root path"
    - "Repository metadata (name, root_path, remote_url) is extracted"
    - "Repositories and packages can be stored in SQLite"
    - "Packages can be retrieved by file path association"
  artifacts:
    - path: "src/indexer/package/git.rs"
      provides: "Git root detection using git2"
      exports: ["discover_git_roots"]
      min_lines: 50
    - path: "src/storage/sqlite/queries/packages.rs"
      provides: "CRUD operations for repositories and packages"
      exports: ["upsert_repository", "upsert_package", "get_package_for_file", "list_all_packages", "list_all_repositories"]
      min_lines: 80
  key_links:
    - from: "src/indexer/package/git.rs"
      to: "src/storage/sqlite/queries/packages.rs"
      via: "upsert_repository called for each discovered git root"
      pattern: "upsert_repository"
    - from: "src/storage/sqlite/queries/packages.rs"
      to: "repositories table"
      via: "UPSERT operation"
      pattern: "INSERT OR REPLACE INTO repositories"
---

<objective>
Implement git repository detection and SQLite storage for packages and repositories

**Purpose:** Discover git repository roots using git2 library, extract repository metadata (name, root path, remote URL), and provide SQLite CRUD operations for storing and retrieving packages and repositories.

**Output:**
- Git root detection using git2::Repository::discover()
- Repository metadata extraction including remote URL from origin
- SQLite CRUD operations for repositories and packages tables
- Package lookup by file path association
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md

@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/09-multi-repo-support/09-CONTEXT.md
@.planning/phases/09-multi-repo-support/09-RESEARCH.md
@.planning/phases/09-multi-repo-support/09-01-SUMMARY.md

@src/storage/sqlite/schema.rs
@src/storage/sqlite/queries/mod.rs
@src/storage/sqlite/queries/symbols.rs
</context>

<context>
## Existing Schema

The repositories and packages tables already exist in schema.rs (lines 353-374):

```sql
CREATE TABLE IF NOT EXISTS repositories (
  id TEXT PRIMARY KEY NOT NULL,
  name TEXT NOT NULL,
  root_path TEXT NOT NULL,
  vcs_type TEXT,
  remote_url TEXT,
  created_at INTEGER NOT NULL DEFAULT (unixepoch())
);

CREATE TABLE IF NOT EXISTS packages (
  id TEXT PRIMARY KEY NOT NULL,
  repository_id TEXT NOT NULL,
  name TEXT NOT NULL,
  version TEXT,
  manifest_path TEXT NOT NULL,
  package_type TEXT NOT NULL,
  created_at INTEGER NOT NULL DEFAULT (unixepoch()),
  FOREIGN KEY(repository_id) REFERENCES repositories(id) ON DELETE CASCADE
);
```

RepositoryRow and PackageRow structs already defined.

## Existing Query Patterns

From src/storage/sqlite/queries/symbols.rs:
- UPSERT pattern: INSERT OR REPLACE INTO ... VALUES (?, ?, ...)
- Batch operations using rusqlite's params_from_iter
- Result mapping using row.try_into()

## Key Decisions from CONTEXT.md

Repository ID format: SHA-256 hash of root_path
Package ID format: SHA-256 hash of manifest_path
All packages in same git root share repo_id
Handle git errors gracefully (not all dirs may be in git)

## Discovery Level: Level 0 (Skip)

All work follows established patterns:
- SQLite query patterns from src/storage/sqlite/queries/symbols.rs
- Git operations use existing git2 dependency
- No new external dependencies required
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create git root detection</name>
  <files>src/indexer/package/git.rs</files>
  <action>
Create src/indexer/package/git.rs with:
- discover_git_roots(manifests: &[PathBuf]) -> Result<Vec<RepositoryInfo>>
- For each manifest path, use git2::Repository::discover(path)
- Extract workdir() as root_path
- Deduplicate roots using HashSet<PathBuf>
- For each unique root:
  - Extract remote URL from origin using repo.find_remote("origin")
  - Build RepositoryInfo with:
    - id: SHA-256 hash of root_path string
    - name: root_path.file_name().unwrap_or_default().to_string_lossy()
    - root_path: absolute path string
    - vcs_type: "git"
    - remote_url: url.url().map(|u| u.to_string()) or None
- Handle git errors gracefully - continue processing other manifests if one fails
- Return Vec of deduplicated RepositoryInfo

Include tests:
- test_discover_git_roots_deduplicates()
- test_discover_git_roots_extracts_remote_url()
  </action>
  <verify>cargo test discover_git_roots passes</verify>
  <done>Git roots are discovered, deduplicated, and RepositoryInfo is created</done>
</task>

<task type="auto">
  <name>Task 2: Create SQLite CRUD operations for packages</name>
  <files>src/storage/sqlite/queries/packages.rs, src/storage/sqlite/queries/mod.rs, src/storage/sqlite/mod.rs</files>
  <action>
Create src/storage/sqlite/queries/packages.rs with:

upsert_repository(conn: &Connection, repo: &RepositoryInfo) -> Result<()>
- INSERT OR REPLACE INTO repositories (id, name, root_path, vcs_type, remote_url, created_at)
- VALUES (?, ?, ?, ?, ?, unixepoch())

upsert_package(conn: &Connection, pkg: &PackageInfo) -> Result<()>
- INSERT OR REPLACE INTO packages (id, repository_id, name, version, manifest_path, package_type, created_at)
- VALUES (?, ?, ?, ?, ?, ?, unixepoch())

get_package_for_file(conn: &Connection, file_path: &str) -> Result<Option<PackageRow>>
- SELECT * FROM packages WHERE ?1 LIKE manifest_path || '%' ORDER BY LENGTH(manifest_path) DESC LIMIT 1
- This finds the deepest package that contains the file

list_all_packages(conn: &Connection) -> Result<Vec<PackageRow>>
- SELECT * FROM packages ORDER BY manifest_path

list_all_repositories(conn: &Connection) -> Result<Vec<RepositoryRow>>
- SELECT * FROM repositories ORDER BY root_path

Update src/storage/sqlite/queries/mod.rs:
- Add: pub mod packages;

Update src/storage/sqlite/mod.rs:
- Re-export package query functions

Include unit tests for all operations
  </action>
  <verify>cargo test upsert_repository && cargo test upsert_package && cargo test get_package_for_file pass</verify>
  <done>Repositories and packages can be stored and retrieved from SQLite</done>
</task>

</tasks>

<verification>
1. Create test workspace with multiple git repositories
2. Run cargo test discover_git_roots
3. Verify git roots are deduplicated correctly
4. Test upsert_repository and upsert_package with mock data
5. Verify get_package_for_file returns correct package for nested files
</verification>

<success_criteria>
- Git roots are discovered and deduplicated
- Repository metadata is extracted (including remote URL)
- Upsert operations correctly insert/update records
- get_package_for_file finds the correct containing package
- All CRUD operations have passing tests
</success_criteria>

<output>
After completion, create `.planning/phases/09-multi-repo-support/09-03-SUMMARY.md`
</output>
