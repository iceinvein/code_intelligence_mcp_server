---
phase: 09-multi-repo-support
plan: 04
type: execute
wave: 2
depends_on: [09-01, 09-02, 09-03]
files_modified:
  - src/indexer/package/mod.rs
  - src/indexer/pipeline/mod.rs
  - src/indexer/mod.rs
  - src/storage/sqlite/mod.rs
  - src/config.rs

autonomous: true

must_haves:
  truths:
    - "Packages are discovered during indexing pipeline execution"
    - "Repositories are detected from package manifest locations"
    - "Packages and repositories are stored in SQLite during indexing"
    - "Package detection can be toggled via config"
  artifacts:
    - path: "src/indexer/package/mod.rs"
      provides: "Complete discover_packages and detect_repositories implementations"
      exports: ["discover_packages", "detect_repositories"]
    - path: "src/indexer/pipeline/mod.rs"
      provides: "Integration with indexing pipeline"
      contains: "discover_packages call during index_all"
    - path: "src/config.rs"
      provides: "Configuration option for package detection"
      contains: "package_detection_enabled"
  key_links:
    - from: "src/indexer/pipeline/mod.rs"
      to: "src/indexer/package/mod.rs"
      via: "discover_packages call during index_all"
      pattern: "discover_packages"
    - from: "src/indexer/package/mod.rs"
      to: "src/storage/sqlite/mod.rs"
      via: "upsert_repository and upsert_package calls"
      pattern: "upsert_(repository|package)"
    - from: "src/config.rs"
      to: "src/indexer/pipeline/mod.rs"
      via: "package_detection_enabled config check"
      pattern: "package_detection_enabled"
---

<objective>
Integrate package detection into indexing pipeline and add configuration controls

**Purpose:** Wire together the package detection components (manifest discovery, parsers, git detection, SQLite storage) into the indexing pipeline so packages and repositories are automatically detected and stored on every index run. Add configuration option to toggle package detection for single-repo workspaces.

**Output:**
- Complete discover_packages() implementation in package/mod.rs
- Complete detect_repositories() implementation in package/mod.rs
- Integration with IndexPipeline::index_all()
- Config option for enabling/disabling package detection
- Logging of discovered packages and repositories
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md

@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/09-multi-repo-support/09-CONTEXT.md
@.planning/phases/09-multi-repo-support/09-RESEARCH.md

@.planning/phases/09-multi-repo-support/09-01-SUMMARY.md
@.planning/phases/09-multi-repo-support/09-02-SUMMARY.md
@.planning/phases/09-multi-repo-support/09-03-SUMMARY.md

@src/indexer/pipeline/mod.rs
@src/storage/sqlite/mod.rs
@src/config.rs
</context>

<context>
## Existing Pipeline Structure

From src/indexer/pipeline/mod.rs, the IndexPipeline has:
- index_all() method that orchestrates full indexing
- scan_files() for file discovery
- index_symbols() for symbol extraction
- SQLite connection management

Package detection should run:
1. After file scanning (we need the workspace scanned)
2. Before symbol indexing (symbols need package association)

## Storage Integration

From src/storage/sqlite/mod.rs, Storage struct provides:
- conn() method for Connection access
- Existing methods for symbols, edges, metrics

Add methods for packages:
- upsert_repository()
- upsert_package()
- get_package_for_file()

These delegate to queries::packages module.

## Configuration Pattern

From src/config.rs, Config struct has boolean toggles like:
- watch_mode: bool (default true)
- enable_file_watcher: bool

Add:
- package_detection_enabled: bool (default true)

## Key Decisions from CONTEXT.md

- Auto-detect monorepo vs multi-repo based on git root count
- Only store internal (workspace-local) dependencies
- Allow disabling package detection for single-repo workspaces

## Discovery Level: Level 0 (Skip)

All work follows established patterns:
- Pipeline integration patterns from existing IndexPipeline
- SQLite storage patterns from src/storage/sqlite/mod.rs
- Configuration patterns from src/config.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Complete discover_packages and detect_repositories implementations</name>
  <files>src/indexer/package/mod.rs</files>
  <action>
Update src/indexer/package/mod.rs to complete the stub implementations:

discover_packages(config: &Config, repo_roots: &[PathBuf]) -> Result<Vec<PackageInfo>>
- For each repo_root, call detector::discover_manifests(config, root)
- Collect all manifests from all roots
- For each manifest, call parsers::parse_manifest() to get PackageInfo
- Return Vec<PackageInfo>

detect_repositories(packages: &[PackageInfo]) -> Result<Vec<RepositoryInfo>>
- Extract manifest paths from packages
- Call git::discover_git_roots() with manifest paths
- Assign repository_id to each package based on git root
- Update packages with their repository_id
- Return Vec<RepositoryInfo>

Use SHA-256 hashing for IDs:
- Package ID: hash of manifest_path string
- Repository ID: hash of root_path string

Add re-exports: pub use detector::discover_manifests;
  </action>
  <verify>cargo build --lib succeeds with implementations</verify>
  <done>discover_packages and detect_repositories are fully implemented</done>
</task>

<task type="auto">
  <name>Task 2: Integrate package detection into indexing pipeline</name>
  <files>src/indexer/pipeline/mod.rs, src/indexer/mod.rs, src/storage/sqlite/mod.rs</files>
  <action>
Update src/indexer/mod.rs:
- Add pub mod package; to expose package module

Update src/indexer/pipeline/mod.rs:
- In IndexPipeline::index_all(), after scanning files:
  1. Check if config.package_detection_enabled
  2. If enabled:
     - Discover packages: let packages = package::discover_packages(&self.config, &self.config.repo_roots)?
     - Detect repositories: let repositories = package::detect_repositories(&packages)?
     - Open SQLite connection
     - Upsert all repositories
     - Upsert all packages with their repository_id
     - Log summary: "Discovered {n} packages in {m} repositories"
- Store packages in IndexPipeline for use during symbol indexing (optional field)

Update src/storage/sqlite/mod.rs:
- Add upsert_repository(conn, repo) -> Result<()> delegating to queries::packages
- Add upsert_package(conn, pkg) -> Result<()> delegating to queries::packages
- Add get_package_for_file(conn, path) -> Result<Option<String>> delegating to queries::packages

Include integration test verifying package detection runs during indexing
  </action>
  <verify>cargo test index_integration shows package detection logs</verify>
  <done>Packages are detected and stored on every index run when enabled</done>
</task>

<task type="auto">
  <name>Task 3: Add config option for package detection</name>
  <files>src/config.rs</files>
  <action>
Update src/config.rs:
- Add pub package_detection_enabled: bool field to Config struct
- Set default to true in Config::default()
- Add to all test Config constructions (find with grep and update)
- Update IndexPipeline to check this flag before calling discover_packages
- Document in comments that this allows disabling for single-repo workspaces

No Cargo.toml changes needed - git2 should already be available.

Verify all Config constructions in tests include the new field.
  </action>
  <verify>cargo build --lib succeeds and all tests compile</verify>
  <done>Package detection can be toggled via config.package_detection_enabled</done>
</task>

</tasks>

<verification>
1. Create test workspace with package.json and Cargo.toml
2. Run indexing with package_detection_enabled = true
3. Check logs for "Discovered N packages in M repositories"
4. Query SQLite: SELECT * FROM packages; and SELECT * FROM repositories;
5. Verify get_package_for_file returns correct package
6. Run indexing with package_detection_enabled = false, verify no packages stored
7. Run cargo test for all new module tests
</verification>

<success_criteria>
- All package types detected in test workspace
- Repositories correctly identified via git root
- SQLite tables contain discovered packages and repositories
- get_package_for_file returns correct package for any indexed file
- Config option enables/disables package detection
- cargo test passes for all new code
- No existing tests broken
</success_criteria>

<output>
After completion, create `.planning/phases/09-multi-repo-support/09-04-SUMMARY.md`
</output>
