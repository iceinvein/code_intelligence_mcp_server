---
phase: 09-multi-repo-support
plan: 06
type: execute
wave: 3
depends_on: [09-05]
files_modified:
  - src/retrieval/query.rs
  - src/retrieval/mod.rs

autonomous: true

must_haves:
  truths:
    - "Query can specify explicit package context via parameter"
    - "Package boost is applied during search pipeline execution"
    - "Package boost is visible in hit_signals for debugging"
  artifacts:
    - path: "src/retrieval/query.rs"
      provides: "Query controls with package_id parameter"
      contains: "QueryControls struct with package field"
    - path: "src/retrieval/mod.rs"
      provides: "Integration of package boost into search pipeline"
      contains: "apply_package_boost_with_signals call"
  key_links:
    - from: "src/retrieval/mod.rs"
      to: "src/retrieval/ranking/package.rs"
      via: "apply_package_boost_with_signals called after affinity boost"
      pattern: "apply_package_boost"
    - from: "src/retrieval/query.rs"
      to: "src/retrieval/mod.rs"
      via: "controls.package passed to ranking function"
      pattern: "controls\\.package"
---

<objective>
Integrate package boost into search pipeline and add query controls

**Purpose:** Wire the package-aware ranking into the main search pipeline and allow users to explicitly specify package context via query parameters (e.g., "myFunction pkg:my-npm-package"). Add package_boost tracking to hit_signals for debugging.

**Output:**
- Package control parameter in query parsing (package: or pkg:)
- Integration of apply_package_boost_with_signals into search() method
- package_boost field in HitSignals for visibility
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md

@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/09-multi-repo-support/09-CONTEXT.md
@.planning/phases/09-multi-repo-support/09-RESEARCH.md

@.planning/phases/09-multi-repo-support/09-05-SUMMARY.md

@src/retrieval/query.rs
@src/retrieval/mod.rs
@src/retrieval/ranking/mod.rs
</context>

<context>
## Existing Query Controls

From src/retrieval/query.rs, QueryControls already supports:
- id: Option<String>
- lang: Option<String>
- kind: Option<String>
- path: Option<String>
- file: Option<String>

Need to add: package: Option<String> for explicit package_id override.

## Existing Search Pipeline

From src/retrieval/mod.rs, search() method applies ranking in sequence:
1. Initial scoring
2. apply_popularity_boost_with_signals
3. apply_file_affinity_boost_with_signals
4. apply_selection_boost_with_signals
5. apply_docstring_boost_with_signals

Package boost should be added after file affinity, before selection boost.

## HitSignals Structure

From src/retrieval/mod.rs, HitSignals tracks all applied boosts:
- popularity_boost: f32
- affinity_boost: f32
- selection_boost: f32
- docstring_boost: f32

Need to add: package_boost: f32

## Key Decisions from CONTEXT.md

Query format: package:package-id or pkg:package-id (shorthand)
Explicit package control overrides auto-detection
Package boost visible in hit_signals for debugging

## Discovery Level: Level 0 (Skip)

All work follows established patterns:
- Query control patterns from existing QueryControls
- Search pipeline integration from existing ranking calls
- HitSignals patterns from existing boost tracking
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add package control to query parsing</name>
  <files>src/retrieval/query.rs</files>
  <action>
Update src/retrieval/query.rs QueryControls struct:
- Add pub package: Option<String> field
- Update parse_query_controls() to extract package parameter
- Support both "package:id" and "pkg:id" formats
- Pattern: match on "package:" or "pkg:" prefix, extract remaining string as package_id
- Update QueryControls::default() to set package: None
- Update any test QueryControls constructions to include package: None

Example queries:
- "myFunction pkg:my-npm-package" -> controls.package = Some("my-npm-package")
- "myFunction package:core-utils" -> controls.package = Some("core-utils")

Include test: test_parse_package_control()
  </action>
  <verify>cargo test parse_query_controls extracts package parameter correctly</verify>
  <done>Query can specify explicit package context via package: or pkg:</done>
</task>

<task type="auto">
  <name>Task 2: Integrate package boost into search pipeline</name>
  <files>src/retrieval/mod.rs</files>
  <action>
Update src/retrieval/mod.rs search() method:

1. Import apply_package_boost_with_signals:
   - use ranking::package::apply_package_boost_with_signals;

2. In search() method, after apply_file_affinity_boost_with_signals call:
   - Extract query_package_id from controls.package.as_deref()
   - Call apply_package_boost_with_signals(hits, &mut hit_signals, query_package_id, &self.config, intent)?
   - Assign result back to hits variable
   - Pass hits through remaining pipeline steps

3. Ensure package boost is applied before selection and docstring boosts

Include integration test:
- test_search_with_package_boost_applies_same_package_priority()
- Create test data with two packages, query from one package's context
- Verify same-package results rank higher

  </action>
  <verify>cargo test search_with_package_boost passes</verify>
  <done>Package boost is applied during search after file affinity</done>
</task>

<task type="auto">
  <name>Task 3: Add package boost to HitSignals</name>
  <files>src/retrieval/mod.rs</files>
  <action>
Update src/retrieval/mod.rs HitSignals struct:

1. Add field:
   - pub package_boost: f32

2. Update HitSignals::default():
   - package_boost: 0.0

3. Update all HitSignals constructions throughout the codebase:
   - Find all HitSignals { ... } constructors
   - Add package_boost: 0.0 to each
   - grep for "HitSignals {" to find all locations

4. Update SearchResponse serialization:
   - Ensure package_boost is included in hit_fields if hit_signals is serialized
   - Check response formatting code

Include test verifying hit_signals contains package_boost after search
  </action>
  <verify>Search response JSON includes package_boost in hit_signals</verify>
  <done>Package boost is visible in search debugging output</done>
</task>

</tasks>

<verification>
1. Start with test data from 09-05
2. Run search with explicit package control: query="helper pkg:utils"
3. Verify utils package results are prioritized
4. Check hit_signals.package_boost > 0 for boosted results
5. Run search without package control, verify auto-detection works
6. Run cargo test for all new tests
</verification>

<success_criteria>
- package: and pkg: query controls are parsed correctly
- Package boost is applied in correct pipeline position
- hit_signals.package_boost reflects applied boost
- Same-package results rank higher than cross-package
- Explicit package control overrides auto-detection
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/09-multi-repo-support/09-06-SUMMARY.md`
</output>
