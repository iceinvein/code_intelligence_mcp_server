---
phase: 09-multi-repo-support
plan: 07
type: execute
wave: 3
depends_on: [09-04]
files_modified:
  - src/indexer/pipeline/edges.rs
  - src/indexer/extract/symbol.rs
  - src/indexer/pipeline/mod.rs

autonomous: true

must_haves:
  truths:
    - "Edges are marked with cross-package resolution when appropriate"
    - "Symbol-to-package association works end-to-end via file_path"
    - "Indexed symbols can be associated with their package"
  artifacts:
    - path: "src/indexer/pipeline/edges.rs"
      provides: "Cross-package edge resolution marking"
      contains: "extract_edges_for_symbol with package detection"
    - path: "src/indexer/extract/symbol.rs"
      provides: "Symbol extraction with package metadata verification"
      contains: "symbol indexing with file_path association"
  key_links:
    - from: "src/indexer/pipeline/edges.rs"
      to: "src/storage/sqlite/queries/packages.rs"
      via: "get_package_for_file to attach package_id to edges"
      pattern: "get_package_for_file"
    - from: "src/indexer/extract/symbol.rs"
      to: "packages table"
      via: "file_path used for package lookup"
      pattern: "get_package_for_file"
---

<objective>
Implement cross-package edge resolution and verify symbol-to-package association

**Purpose:** Mark edges with their package resolution context (local, package, cross-package) during indexing and verify that symbol-to-package association works end-to-end for package-aware search functionality.

**Output:**
- Edge creation with package-aware resolution marking
- Cross-package edges identified and marked
- Symbol-to-package association verified via file_path
- Logging of package membership during indexing
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md

@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/09-multi-repo-support/09-CONTEXT.md
@.planning/phases/09-multi-repo-support/09-RESEARCH.md

@.planning/phases/09-multi-repo-support/09-04-SUMMARY.md

@src/indexer/pipeline/edges.rs
@src/indexer/extract/symbol.rs
@src/indexer/pipeline/mod.rs
@src/storage/sqlite/schema.rs
</context>

<context>
## Existing Edge Resolution

From src/indexer/pipeline/edges.rs, edges have:
- from_symbol_id, to_symbol_id, edge_type
- at_file, at_line, confidence, evidence_count, resolution

The resolution field is TEXT, allowing flexible values:
- Current: "local", "dynamic", "workspace"
- New: "local", "package", "cross-package"

## Edge Creation Pattern

extract_edges_for_symbol() creates edges by:
1. Finding target symbols (by name, type, scope)
2. Creating EdgeRow with resolution status
3. Storing via SQLite

## Symbol-to-Package Association

From src/storage/sqlite/schema.rs, symbols table has:
- file_path: TEXT NOT NULL

Package association is computed via:
- get_package_for_file(file_path) -> finds package whose manifest_path is a prefix

No schema change needed - association is derived from existing file_path.

## Key Decisions from CONTEXT.md

Cross-package resolution:
- Check if from and to symbols are in same package
- Mark edges as:
  - "local" if same file
  - "package" if same package, different file
  - "cross-package" if different package
- Prefer same-package resolution when multiple candidates exist
- Log cross-package edges at DEBUG level

## Discovery Level: Level 0 (Skip)

All work follows established patterns:
- Edge creation patterns from edges.rs
- Symbol extraction patterns from symbol.rs
- Package lookup via get_package_for_file from 09-03
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add cross-package resolution to edge creation</name>
  <files>src/indexer/pipeline/edges.rs</files>
  <action>
Update src/indexer/pipeline/edges.rs:

In extract_edges_for_symbol():

1. Get package_id for from_symbol:
   - Query get_package_for_file(from_symbol.file_path)
   - Store as from_package

2. For each target resolution:
   - Get package_id for target_symbol using get_package_for_file
   - Determine edge resolution:
     - If same file: resolution = "local"
     - Else if from_package == to_package: resolution = "package"
     - Else: resolution = "cross-package"
   - Include package_id in resolution metadata if cross-package

3. Log cross-package edges at DEBUG level:
   - "Cross-package edge: {from} -> {to} (from {from_pkg} to {to_pkg})"

4. Update EdgeRow resolution field with new value

Note: No schema change needed (resolution is TEXT)

Include test: test_cross_package_edge_resolution()
  </action>
  <verify>cargo test cross_package_edge passes</verify>
  <done>Edges are marked with cross-package resolution when appropriate</done>
</task>

<task type="auto">
  <name>Task 2: Update symbol extraction to include package metadata</name>
  <files>src/indexer/extract/symbol.rs, src/indexer/pipeline/mod.rs</files>
  <action>
This task verifies that symbol-to-package association works correctly.

In src/indexer/pipeline/mod.rs, during index_symbols():
- Add logging to show which package each file belongs to
- For each file being indexed:
  - Look up package via get_package_for_file
  - Log at DEBUG: "Indexing {file} (package: {package_id})"
  - If no package found, log at TRACE: "No package for {file}"

In src/indexer/extract/symbol.rs:
- Verify that file_path is correctly stored for all symbols
- No code changes needed - this is verification

Include integration test:
- test_symbol_to_package_association()
- Create test file with symbols
- Index and verify symbols have file_path
- Query get_package_for_file with symbol's file_path
- Assert package is found
  </action>
  <verify>Indexed symbols can be associated with their package via file_path</verify>
  <done>Symbol-to-package association works end-to-end</done>
</task>

</tasks>

<verification>
1. Create test workspace with multiple packages:
   - packages/core/package.json (CoreUtils)
   - packages/utils/package.json (utilHelper)
   - Core imports from utils

2. Index workspace

3. Verify edges:
   - Same-file edges: resolution = "local"
   - Same-package edges: resolution = "package"
   - Cross-package edges: resolution = "cross-package"

4. Verify symbol association:
   - Query symbol by ID
   - Get file_path from symbol
   - Query get_package_for_file(file_path)
   - Assert correct package returned

5. Run cargo test for all tests
</verification>

<success_criteria>
- Edges are correctly marked by resolution type
- Cross-package edges show package information
- Symbol file_path allows package lookup
- Logging shows package membership during indexing
- All tests pass
- No existing tests broken
</success_criteria>

<output>
After completion, create `.planning/phases/09-multi-repo-support/09-07-SUMMARY.md`
</output>
